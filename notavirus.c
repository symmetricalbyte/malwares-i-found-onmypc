#include <windows.h>
#include <stdio.h>
#include <stdlib.h>
#include <time.h>

int getRandomInRange(int min, int max)
{
  if (min > max)
  {
    return -1;
  }
  return min + rand() % (max - min + 1);
}

void setCursorPosition(int x, int y)
{
  HANDLE hConsole = GetStdHandle(STD_OUTPUT_HANDLE);
  COORD coord = {x, y};
  SetConsoleCursorPosition(hConsole, coord);
}

void clearLine()
{
  HANDLE hConsole = GetStdHandle(STD_OUTPUT_HANDLE);
  COORD coord = {0, 0};
  DWORD written;
  CONSOLE_SCREEN_BUFFER_INFO csbi;

  GetConsoleScreenBufferInfo(hConsole, &csbi);
  DWORD length = csbi.dwSize.X;

  FillConsoleOutputCharacter(hConsole, ' ', length, coord, &written);
  SetConsoleCursorPosition(hConsole, coord);
}

void printLoadingBar(int progress, int total)
{
  int barWidth = 50;
  float progressPercent = (float)progress / total;
  int pos = barWidth * progressPercent;
  setCursorPosition(0, 1);
  printf("[");
  for (int i = 0; i < barWidth; i++)
  {
    if (i < pos)
    {
      printf("#");
    }
    else
    {
      printf(" ");
    }
  }
  printf("] %.2f%%\r", progressPercent * 100);
  fflush(stdout);
}

void APIENTRY msgBox(HINSTANCE hInst, HINSTANCE hInstPrev, PSTR cmdline, int cmdshow)
{
  return MessageBox(0, "Hi, I am an Bangladeshi virus but because of poor technology in my country, unfortunately I am not able to harm your computer. Please be kind and delete one of you important files and then forward me to other users. If you want your deleted files back please sent 0.15 ETH to the following adress. Thank you for your cooperation!\nETH wallet adress: 0x532Fb5D00f40ced99B16d1E295C77Cda2Eb1BB4F\n\nBest regards,\n@desymmetric", "Virus Alert", MB_OK | MB_ICONERROR);
}

void APIENTRY consoleBox(HINSTANCE hInst, HINSTANCE hInstPrev, PSTR cmdline, int cmdshow)
{
  srand((unsigned int)time(NULL));
  AllocConsole();
  FILE *consoleOutput;
  freopen_s(&consoleOutput, "CONOUT$", "w", stdout);
  printf("deleting C:\\Windows\\System32\n");
  Sleep(2000);
  for (int i = 0; i <= 100; i++)
  {
    printLoadingBar(i, 100);
    Sleep(getRandomInRange(30, 130));
  };
  setCursorPosition(0, 2);
  fflush(stdout);
  printf("done, have a nice day!\n");
  Sleep(3000);
  fclose(consoleOutput);
  FreeConsole();
}

int APIENTRY WinMain(HINSTANCE hInst, HINSTANCE hInstPrev, PSTR cmdline, int cmdshow)
{
  HANDLE msgBoxThread, consoleBoxThread;

  msgBoxThread = CreateThread(NULL, 0, msgBox, NULL, 0, NULL);
  consoleBoxThread = CreateThread(NULL, 0, consoleBox, NULL, 0, NULL);
  WaitForSingleObject(msgBoxThread, INFINITE);
  WaitForSingleObject(consoleBoxThread, INFINITE);
  CloseHandle(msgBoxThread);
  CloseHandle(consoleBoxThread);
}
